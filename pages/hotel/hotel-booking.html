<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="호텔 예약 정보 입력">
  <title>호텔 예약 | TravelKorea</title>

  <!-- AIBE5 Styles -->
  <link rel="stylesheet" href="../css/common/style.css">
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- Page Styles -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/pages/hotel-booking.css">
</head>

<body>

  <!-- Header (Dynamic from AIBE5) -->
  <header>
  </header>

  <!-- Main Content -->
  <main>

    <!-- Page Header -->
    <div class="page-header" style="padding-top: 0;">
      <div class="header-banner">
        <h1 class="page-title">숙소 예약</h1>
      </div>
    </div>

    <div class="container">
      <div class="booking-grid">

        <!-- Booking Form -->
        <div class="booking-form-section">
          <form class="booking-form" id="bookingForm">

            <!-- Hotel Info -->
            <div class="form-card">
              <h2 class="section-title">숙소 정보</h2>
              <div class="hotel-info">
                <div class="hotel-info-image">
                  <img id="hotelImage" alt="숙소 이미지">
                </div>
                <div class="hotel-info-content">
                  <h3 id="hotelName"></h3>
                  <p id="hotelLocation"></p>
                </div>
              </div>
            </div>

            <!-- Booking Details -->
            <div class="form-card">
              <h2 class="section-title">예약 정보</h2>

              <div class="form-row">
                <div class="form-group">
                  <label class="required">체크인</label>
                  <input type="date" id="checkIn" required>
                  <span class="error-message">체크인 날짜를 선택해주세요</span>
                </div>
                <div class="form-group">
                  <label class="required">체크아웃</label>
                  <input type="date" id="checkOut" required>
                  <span class="error-message">체크아웃 날짜를 선택해주세요</span>
                </div>
              </div>

              <div class="form-group">
                <label class="required">객실 유형</label>
                <select id="roomType" required>
                  <option value="standard">스탠다드 (기본 요금)</option>
                  <option value="deluxe">디럭스 (+30%)</option>
                  <option value="suite">스위트 (+70%)</option>
                </select>
              </div>

              <div class="form-group">
                <label>인원</label>
                <select id="guestCount">
                  <option value="1">1명</option>
                  <option value="2" selected>2명</option>
                  <option value="3">3명</option>
                  <option value="4">4명</option>
                </select>
              </div>
            </div>

            <!-- Guest Info -->
            <div class="form-card">
              <h2 class="section-title">예약자 정보</h2>

              <div class="form-row">
                <div class="form-group">
                  <label class="required">이름</label>
                  <input type="text" id="guestName" placeholder="홍길동" required>
                  <span class="error-message">이름을 입력해주세요</span>
                </div>
                <div class="form-group">
                  <label class="required">영문 이름</label>
                  <input type="text" id="guestNameEn" placeholder="Hong Gildong" required>
                  <span class="error-message">영문 이름을 입력해주세요</span>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="required">전화번호</label>
                  <input type="tel" id="phone" placeholder="010-1234-5678" required>
                  <span class="error-message">전화번호를 입력해주세요</span>
                </div>
                <div class="form-group">
                  <label class="required">이메일</label>
                  <input type="email" id="email" placeholder="example@email.com" required>
                  <span class="error-message">이메일을 입력해주세요</span>
                </div>
              </div>

              <div class="form-group">
                <label>특별 요청사항</label>
                <textarea id="specialRequest" placeholder="특별한 요청사항이 있으시면 입력해주세요 (선택사항)"></textarea>
              </div>
            </div>

            <!-- Payment Method -->
            <div class="form-card">
              <h2 class="section-title">결제 방법</h2>

              <div class="payment-methods">
                <label class="payment-option">
                  <input type="radio" name="payment" value="card" checked>
                  <span class="payment-label">신용/체크카드</span>
                </label>
                <label class="payment-option">
                  <input type="radio" name="payment" value="transfer">
                  <span class="payment-label">계좌이체</span>
                </label>
                <label class="payment-option">
                  <input type="radio" name="payment" value="phone">
                  <span class="payment-label">휴대폰 결제</span>
                </label>
              </div>
            </div>

            <!-- Terms Agreement -->
            <div class="form-card">
              <h2 class="section-title">약관 동의</h2>

              <div class="terms-agreement">
                <label class="checkbox-group">
                  <input type="checkbox" id="agreeAll">
                  <span><strong>전체 동의</strong></span>
                </label>
                <label class="checkbox-group">
                  <input type="checkbox" id="agreeTerms" required>
                  <span>이용약관 동의 (필수)</span>
                </label>
                <label class="checkbox-group">
                  <input type="checkbox" id="agreePrivacy" required>
                  <span>개인정보 수집 및 이용 동의 (필수)</span>
                </label>
                <label class="checkbox-group">
                  <input type="checkbox" id="agreeMarketing">
                  <span>마케팅 정보 수신 동의 (선택)</span>
                </label>
              </div>
            </div>

          </form>
        </div>

        <!-- Booking Summary -->
        <div class="booking-summary-section">
          <div class="booking-summary">
            <h2 class="section-title">예약 요약</h2>

            <div class="summary-hotel">
              <div class="summary-hotel-image">
                <img id="summaryHotelImage" alt="숙소 이미지">
              </div>
              <div class="summary-hotel-info">
                <h3 id="summaryHotelName"></h3>
                <p id="summaryLocation"></p>
              </div>
            </div>

            <div class="summary-details">
              <div class="summary-row">
                <span class="summary-label">체크인</span>
                <span class="summary-value" id="summaryCheckIn">-</span>
              </div>
              <div class="summary-row">
                <span class="summary-label">체크아웃</span>
                <span class="summary-value" id="summaryCheckOut">-</span>
              </div>
              <div class="summary-row">
                <span class="summary-label">숙박일수</span>
                <span class="summary-value" id="summaryNights">0박</span>
              </div>
              <div class="summary-row">
                <span class="summary-label">객실 유형</span>
                <span class="summary-value" id="summaryRoomType">스탠다드</span>
              </div>
              <div class="summary-row">
                <span class="summary-label">인원</span>
                <span class="summary-value" id="summaryGuests">2명</span>
              </div>
            </div>

            <div class="price-breakdown">
              <div class="price-row">
                <span>1박 요금</span>
                <span id="pricePerNight">0원</span>
              </div>
              <div class="price-row">
                <span>숙박일수</span>
                <span id="nightsMultiplier">x 0박</span>
              </div>
              <div class="price-row total-price">
                <span>총 결제금액</span>
                <span id="totalPrice">0원</span>
              </div>
            </div>

            <button type="submit" form="bookingForm" class="btn-submit" id="submitBtn">
              결제하기
            </button>

            <button type="button" class="btn-schedule" id="scheduleBtn">
              일정에 담기
            </button>
          </div>
        </div>

      </div>
    </div>
  </main>

  <!-- AIBE5 Scripts -->
  <script src="../../js/common/header.js"></script>
  <script src="../../js/common/script.js"></script>

  <script>
    // 예약 데이터 불러오기
    const bookingData = JSON.parse(sessionStorage.getItem("bookingData"));

    if (!bookingData) {
      alert("예약 정보가 없습니다.");
      location.href = "hotel.html";
    }

    // 객실 타입별 가격 배수
    const roomPrices = {
      standard: 1,
      deluxe: 1.3,
      suite: 1.7
    };

    // 객실 타입 한글 변환
    const roomTypeNames = {
      standard: "스탠다드",
      deluxe: "디럭스",
      suite: "스위트"
    };

    // DOM 요소
    const hotelImage = document.getElementById("hotelImage");
    const hotelName = document.getElementById("hotelName");
    const hotelLocation = document.getElementById("hotelLocation");
    const summaryHotelImage = document.getElementById("summaryHotelImage");
    const summaryHotelName = document.getElementById("summaryHotelName");
    const summaryLocation = document.getElementById("summaryLocation");

    const checkInInput = document.getElementById("checkIn");
    const checkOutInput = document.getElementById("checkOut");
    const roomTypeSelect = document.getElementById("roomType");
    const guestCountSelect = document.getElementById("guestCount");

    const summaryCheckIn = document.getElementById("summaryCheckIn");
    const summaryCheckOut = document.getElementById("summaryCheckOut");
    const summaryNights = document.getElementById("summaryNights");
    const summaryRoomType = document.getElementById("summaryRoomType");
    const summaryGuests = document.getElementById("summaryGuests");

    const pricePerNight = document.getElementById("pricePerNight");
    const nightsMultiplier = document.getElementById("nightsMultiplier");
    const totalPriceDisplay = document.getElementById("totalPrice");

    // 숙소 정보 표시
    hotelImage.src = bookingData.image;
    hotelName.textContent = bookingData.hotelName;
    hotelLocation.textContent = bookingData.region;
    summaryHotelImage.src = bookingData.image;
    summaryHotelName.textContent = bookingData.hotelName;
    summaryLocation.textContent = bookingData.region;

    // 최소 날짜 설정 (오늘 이후)
    const today = new Date().toISOString().split('T')[0];
    checkInInput.setAttribute('min', today);
    checkOutInput.setAttribute('min', today);

    // 숙박 일수 계산
    function getNights(checkIn, checkOut) {
      const start = new Date(checkIn);
      const end = new Date(checkOut);
      const nights = (end - start) / (1000 * 60 * 60 * 24);
      return nights > 0 ? nights : 0;
    }

    // 가격 계산 및 표시
    function calculatePrice() {
      const roomType = roomTypeSelect.value;
      const checkIn = checkInInput.value;
      const checkOut = checkOutInput.value;
      const guests = guestCountSelect.value;

      // 요약 업데이트
      summaryCheckIn.textContent = checkIn || "-";
      summaryCheckOut.textContent = checkOut || "-";
      summaryRoomType.textContent = roomTypeNames[roomType];
      summaryGuests.textContent = guests + "명";

      if (!checkIn || !checkOut) {
        summaryNights.textContent = "0박";
        pricePerNight.textContent = "0원";
        nightsMultiplier.textContent = "x 0박";
        totalPriceDisplay.textContent = "0원";
        return;
      }

      const nights = getNights(checkIn, checkOut);

      if (nights <= 0) {
        summaryNights.textContent = "0박";
        pricePerNight.textContent = "0원";
        nightsMultiplier.textContent = "x 0박";
        totalPriceDisplay.textContent = "0원";
        return;
      }

      const basePrice = bookingData.basePrice * roomPrices[roomType];
      const total = basePrice * nights;

      summaryNights.textContent = `${nights}박`;
      pricePerNight.textContent = `${basePrice.toLocaleString()}원`;
      nightsMultiplier.textContent = `x ${nights}박`;
      totalPriceDisplay.textContent = `${total.toLocaleString()}원`;
    }

    // 이벤트 리스너
    checkInInput.addEventListener("change", function () {
      const checkInDate = new Date(this.value);
      checkInDate.setDate(checkInDate.getDate() + 1);
      const minCheckOut = checkInDate.toISOString().split('T')[0];
      checkOutInput.setAttribute('min', minCheckOut);

      if (checkOutInput.value && checkOutInput.value <= this.value) {
        checkOutInput.value = '';
      }
      calculatePrice();
    });

    checkOutInput.addEventListener("change", calculatePrice);
    roomTypeSelect.addEventListener("change", calculatePrice);
    guestCountSelect.addEventListener("change", calculatePrice);

    // 전체 동의 체크박스
    document.getElementById('agreeAll').addEventListener('change', function () {
      const checkboxes = document.querySelectorAll('.terms-agreement input[type="checkbox"]:not(#agreeAll)');
      checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });
    });

    // 개별 체크박스 변경 시 전체 동의 체크 업데이트
    document.querySelectorAll('.terms-agreement input[type="checkbox"]:not(#agreeAll)').forEach(checkbox => {
      checkbox.addEventListener('change', function () {
        const allChecked = Array.from(
          document.querySelectorAll('.terms-agreement input[type="checkbox"]:not(#agreeAll)')
        ).every(cb => cb.checked);
        document.getElementById('agreeAll').checked = allChecked;
      });
    });

    // 폼 유효성 검사
    function validateForm() {
      let isValid = true;

      // 체크인 검사
      const checkIn = document.getElementById('checkIn');
      if (!checkIn.value) {
        checkIn.closest('.form-group').classList.add('error');
        isValid = false;
      } else {
        checkIn.closest('.form-group').classList.remove('error');
      }

      // 체크아웃 검사
      const checkOut = document.getElementById('checkOut');
      if (!checkOut.value) {
        checkOut.closest('.form-group').classList.add('error');
        isValid = false;
      } else {
        checkOut.closest('.form-group').classList.remove('error');
      }

      // 날짜 유효성 검사
      if (checkIn.value && checkOut.value) {
        const nights = getNights(checkIn.value, checkOut.value);
        if (nights <= 0) {
          alert('체크아웃 날짜는 체크인 날짜 이후여야 합니다.');
          isValid = false;
        }
      }

      // 이름 검사
      const guestName = document.getElementById('guestName');
      if (!guestName.value.trim()) {
        guestName.closest('.form-group').classList.add('error');
        isValid = false;
      } else {
        guestName.closest('.form-group').classList.remove('error');
      }

      // 영문 이름 검사
      const guestNameEn = document.getElementById('guestNameEn');
      if (!guestNameEn.value.trim()) {
        guestNameEn.closest('.form-group').classList.add('error');
        isValid = false;
      } else {
        guestNameEn.closest('.form-group').classList.remove('error');
      }

      // 전화번호 검사
      const phone = document.getElementById('phone');
      if (!phone.value.trim()) {
        phone.closest('.form-group').classList.add('error');
        isValid = false;
      } else {
        phone.closest('.form-group').classList.remove('error');
      }

      // 이메일 검사
      const email = document.getElementById('email');
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!email.value.trim() || !emailRegex.test(email.value)) {
        email.closest('.form-group').classList.add('error');
        isValid = false;
      } else {
        email.closest('.form-group').classList.remove('error');
      }

      // 필수 약관 동의 검사
      const agreeTerms = document.getElementById('agreeTerms');
      const agreePrivacy = document.getElementById('agreePrivacy');
      if (!agreeTerms.checked || !agreePrivacy.checked) {
        alert('필수 약관에 동의해주세요.');
        isValid = false;
      }

      return isValid;
    }

    // 폼 제출
    document.getElementById('bookingForm').addEventListener('submit', function (e) {
      e.preventDefault();

      if (!validateForm()) {
        return;
      }

      const checkIn = checkInInput.value;
      const checkOut = checkOutInput.value;
      const roomType = roomTypeSelect.value;
      const nights = getNights(checkIn, checkOut);
      const basePrice = bookingData.basePrice * roomPrices[roomType];
      const totalPrice = basePrice * nights;

      // 예약 완료 데이터 저장
      const reservationData = {
        ...bookingData,
        checkIn: checkIn,
        checkOut: checkOut,
        nights: nights,
        roomType: roomType,
        guestCount: guestCountSelect.value,
        basePrice: basePrice,
        totalPrice: totalPrice,
        guestName: document.getElementById('guestName').value,
        guestNameEn: document.getElementById('guestNameEn').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        specialRequest: document.getElementById('specialRequest').value,
        paymentMethod: document.querySelector('input[name="payment"]:checked').value,
        reservationDate: new Date().toISOString(),
        reservationNumber: 'RES' + Date.now(),
        username: 'noname' // 추후 로그인 정보에서 username 추출하는 로직 추가
      };

      // localStorage에 저장
      const reservations = JSON.parse(localStorage.getItem('myReservations')) || [];
      reservations.push(reservationData);
      localStorage.setItem('myReservations', JSON.stringify(reservations));

      // 예약 완료 알림
      alert(
        `예약이 완료되었습니다!\n\n` +
        `예약번호: ${reservationData.reservationNumber}\n` +
        `호텔: ${bookingData.hotelName}\n` +
        `체크인: ${checkIn}\n` +
        `체크아웃: ${checkOut}\n` +
        `객실: ${roomTypeNames[roomType]}\n` +
        `총 금액: ${totalPrice.toLocaleString()}원\n\n` +
        `예약 확인 이메일이 발송됩니다.`
      );

      // sessionStorage 정리
      sessionStorage.removeItem('bookingData');

      // 호텔 목록으로 이동
      location.href = 'hotel.html';
    });

    // 일정에 담기 버튼
    document.getElementById('scheduleBtn').addEventListener('click', function () {
      const schedules = JSON.parse(localStorage.getItem("mySchedules")) || [];

      const exists = schedules.some(s => s.name === bookingData.hotelName && s.type === "hotel");

      if (exists) {
        alert("이미 일정에 추가된 숙소입니다.");
        return;
      }

      schedules.push({
        id: Date.now(),
        originalId: parseInt(bookingData.hotelId),
        name: bookingData.hotelName,
        image: bookingData.image,
        location: bookingData.region,
        description: `1박 ${bookingData.basePrice.toLocaleString()}원부터`,
        type: "hotel",
        addedAt: new Date().toISOString()
      });

      localStorage.setItem("mySchedules", JSON.stringify(schedules));
      alert("일정이 추가되었습니다!");
    });

    // 초기화
    calculatePrice();
  </script>
</body>

</html>